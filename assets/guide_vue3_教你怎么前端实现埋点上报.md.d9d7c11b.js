import{_ as s,o as a,c as n,N as l}from"./chunks/framework.60272d8a.js";const D=JSON.parse('{"title":"教你怎么前端实现埋点上报 - 掘金","description":"","frontmatter":{},"headers":[],"relativePath":"guide/vue3/教你怎么前端实现埋点上报.md","lastUpdated":1706686109000}'),p={name:"guide/vue3/教你怎么前端实现埋点上报.md"},o=l(`<h1 id="教你怎么前端实现埋点上报-掘金" tabindex="-1">教你怎么前端实现埋点上报 - 掘金 <a class="header-anchor" href="#教你怎么前端实现埋点上报-掘金" aria-label="Permalink to &quot;教你怎么前端实现埋点上报 - 掘金&quot;">​</a></h1><h2 id="前言" tabindex="-1">前言 <a class="header-anchor" href="#前言" aria-label="Permalink to &quot;前言&quot;">​</a></h2><p><code>只有了解用户，我们才能服务好用户，而最接近用户的我们，自然要承担起更多的责任。</code></p><p>那么在一个企业中，我们要如何去了解用户呢？<br> 最直接有效的方式就是了解用户的行为，了解用户在网站中做了什么，呆了多久。<br> 而如何去实现这一操作，这就涉及到我们前端的埋点了。</p><h2 id="埋点方式" tabindex="-1">埋点方式 <a class="header-anchor" href="#埋点方式" aria-label="Permalink to &quot;埋点方式&quot;">​</a></h2><p>在聊如何进行埋点前，我们先介绍下什么是埋点？</p><p><code>所谓&#39;埋点&#39;是数据采集领域（尤其是用户行为数据采集领域）的术语，指的是针对特定用户行为或事件进行捕获、处理和发送的相关技术及其实施过程。. 比如用户某个icon点击次数、观看某个视频的时长等等。</code><br><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.woshipm.com%2Fdata-analysis%2F1209537.html%23%3A~%3Atext%3D%25E5%259F%258B%25E7%2582%25B9%25E6%2598%25AF%25E4%25BB%2580%25E4%25B9%2588%25EF%25BC%259F.%2520%25E6%2589%2580%25E8%25B0%2593%2522%25E5%259F%258B%25E7%2582%25B9%2522%25EF%25BC%258C%25E6%2598%25AF%25E6%2595%25B0%25E6%258D%25AE%25E9%2587%2587%25E9%259B%2586%25E9%25A2%2586%25E5%259F%259F%25EF%25BC%2588%25E5%25B0%25A4%25E5%2585%25B6%25E6%2598%25AF%25E7%2594%25A8%25E6%2588%25B7%25E8%25A1%258C%25E4%25B8%25BA%25E6%2595%25B0%25E6%258D%25AE%25E9%2587%2587%25E9%259B%2586%25E9%25A2%2586%25E5%259F%259F%25EF%25BC%2589%25E7%259A%2584%25E6%259C%25AF%25E8%25AF%25AD%25EF%25BC%258C%25E6%258C%2587%25E7%259A%2584%25E6%2598%25AF%25E9%2592%2588%25E5%25AF%25B9%25E7%2589%25B9%25E5%25AE%259A%25E7%2594%25A8%25E6%2588%25B7%25E8%25A1%258C%25E4%25B8%25BA%25E6%2588%2596%25E4%25BA%258B%25E4%25BB%25B6%25E8%25BF%259B%25E8%25A1%258C%25E6%258D%2595%25E8%258E%25B7%25E3%2580%2581%25E5%25A4%2584%25E7%2590%2586%25E5%2592%258C%25E5%258F%2591%25E9%2580%2581%25E7%259A%2584%25E7%259B%25B8%25E5%2585%25B3%25E6%258A%2580%25E6%259C%25AF%25E5%258F%258A%25E5%2585%25B6%25E5%25AE%259E%25E6%2596%25BD%25E8%25BF%2587%25E7%25A8%258B%25E3%2580%2582.%2520%25E6%25AF%2594%25E5%25A6%2582%25E7%2594%25A8%25E6%2588%25B7%25E6%259F%2590%25E4%25B8%25AAicon%25E7%2582%25B9%25E5%2587%25BB%25E6%25AC%25A1%25E6%2595%25B0%25E3%2580%2581%25E8%25A7%2582%25E7%259C%258B%25E6%259F%2590%25E4%25B8%25AA%25E8%25A7%2586%25E9%25A2%2591%25E7%259A%2584%25E6%2597%25B6%25E9%2595%25BF%25E7%25AD%2589%25E7%25AD%2589%25E3%2580%2582.%2520%25E5%259F%258B%25E7%2582%25B9%25E7%259A%2584%25E6%258A%2580%25E6%259C%25AF%25E5%25AE%259E%25E8%25B4%25A8%25EF%25BC%258C%25E6%2598%25AF%25E5%2585%2588%25E7%259B%2591%25E5%2590%25AC%25E8%25BD%25AF%25E4%25BB%25B6%25E5%25BA%2594%25E7%2594%25A8%25E8%25BF%2590%25E8%25A1%258C%25E8%25BF%2587%25E7%25A8%258B%25E4%25B8%25AD%25E7%259A%2584%25E4%25BA%258B%25E4%25BB%25B6%25EF%25BC%258C%25E5%25BD%2593%25E9%259C%2580%25E8%25A6%2581%25E5%2585%25B3%25E6%25B3%25A8%25E7%259A%2584%25E4%25BA%258B%25E4%25BB%25B6%25E5%258F%2591%25E7%2594%259F%25E6%2597%25B6%25E8%25BF%259B%25E8%25A1%258C%25E5%2588%25A4%25E6%2596%25AD%25E5%2592%258C%25E6%258D%2595%25E8%258E%25B7%25E3%2580%2582.%2C%25E7%2589%25B9%25E5%2588%25AB%25E6%25B3%25A8%25E6%2584%258F%25E9%259C%2580%25E8%25A6%2581%25E6%2598%258E%25E7%25A1%25AE%25E4%25BA%258B%25E4%25BB%25B6%25E5%258F%2591%25E7%2594%259F%25E6%2597%25B6%25E9%2597%25B4%25E7%2582%25B9%25E3%2580%2581%25E5%2588%25A4%25E5%2588%25AB%25E6%259D%25A1%25E4%25BB%25B6%25EF%25BC%258C%25E8%25BF%2599%25E9%2587%258C%25E5%25A6%2582%25E6%259E%259C%25E9%2581%2587%25E5%2588%25B0%25E4%25B8%258D%25E6%25B8%2585%25E6%25A5%259A%25E7%259A%2584%25EF%25BC%258C%25E9%259C%2580%25E8%25A6%2581%25E5%2592%258C%25E5%25BC%2580%25E5%258F%2591%25E6%25B2%259F%25E9%2580%259A%25E6%25B8%2585%25E6%25A5%259A%25EF%25BC%258C%25E9%2581%25BF%25E5%2585%258D%25E9%2587%2587%25E9%259B%2586%25E6%2595%25B0%25E6%258D%25AE%25E4%25B8%258E%25E7%2590%2586%25E6%2583%25B3%25E5%25AD%2598%25E5%259C%25A8%25E5%25B7%25AE%25E5%25BC%2582%25E3%2580%2582.%2520%25E4%25BE%258B%25E5%25A6%2582%25EF%25BC%259A%25E6%259C%259F%25E6%259C%259B%25E9%2587%2587%25E9%259B%2586%25E6%259F%2590%25E4%25B8%25AAapp%25E7%259A%2584%25E6%259F%2590%25E4%25B8%25AA%25E5%25B9%25BF%25E5%2591%258A%25E7%259A%2584%25E6%259C%2589%25E6%2595%2588%25E6%259B%259D%25E5%2585%2589%25E6%2595%25B0%25EF%25BC%258C%25E6%259C%2589%25E6%2595%2588%25E6%259B%259D%25E5%2585%2589%25E7%259A%2584%25E5%2588%25A4%25E5%2588%25AB%25E6%259D%25A1%25E4%25BB%25B6%25E6%2598%25AF%25E5%2581%259C%25E7%2595%2599%25E6%2597%25B6%25E9%2595%25BF%25E8%25B6%2585%25E8%25BF%25871%25E7%25A7%2592%25E4%25B8%2594%25E6%259C%2589%25E6%2595%2588%25E5%258A%25A0%25E8%25BD%25BD%25E5%2587%25BA%25E5%25B9%25BF%25E5%2591%258A%25E5%2586%2585%25E5%25AE%25B9%25E3%2580%2582.%25202.%2520%25E5%259F%258B%25E7%2582%25B9%25E6%2598%25AF%25E8%25B0%2581%25E7%259A%2584%25E5%25B7%25A5%25E4%25BD%259C%25EF%25BC%259F.%2520%25E7%258E%25B0%25E5%259C%25A8%25E5%2585%25AC%25E5%258F%25B8%25E9%2580%259A%25E5%25B8%25B8%25E9%2583%25BD%25E4%25BC%259A%25E6%259C%2589%25E6%2595%25B0%25E6%258D%25AE%25E4%25BA%25A7%25E5%2593%2581%25E7%25BB%258F%25E7%2590%2586%25E6%2588%2596%25E4%25B8%259A%25E5%258A%25A1%25E7%25BA%25BF%25E6%2595%25B0%25E6%258D%25AE%25E5%2588%2586%25E6%259E%2590%25E5%25B8%2588%25EF%25BC%258C%25E7%25BB%2593%25E5%2590%2588%25E7%2589%2588%25E6%259C%25AC%25E8%25BF%25AD%25E4%25BB%25A3%25E8%25BF%2587%25E7%25A8%258B%25E8%25BF%259B%25E8%25A1%258C%25E5%259F%258B%25E7%2582%25B9%25E8%25A7%2584%25E5%2588%2592%25E3%2580%2582." title="https://www.woshipm.com/data-analysis/1209537.html#:~:text=%E5%9F%8B%E7%82%B9%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F.%20%E6%89%80%E8%B0%93%22%E5%9F%8B%E7%82%B9%22%EF%BC%8C%E6%98%AF%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E9%A2%86%E5%9F%9F%EF%BC%88%E5%B0%A4%E5%85%B6%E6%98%AF%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%95%B0%E6%8D%AE%E9%87%87%E9%9B%86%E9%A2%86%E5%9F%9F%EF%BC%89%E7%9A%84%E6%9C%AF%E8%AF%AD%EF%BC%8C%E6%8C%87%E7%9A%84%E6%98%AF%E9%92%88%E5%AF%B9%E7%89%B9%E5%AE%9A%E7%94%A8%E6%88%B7%E8%A1%8C%E4%B8%BA%E6%88%96%E4%BA%8B%E4%BB%B6%E8%BF%9B%E8%A1%8C%E6%8D%95%E8%8E%B7%E3%80%81%E5%A4%84%E7%90%86%E5%92%8C%E5%8F%91%E9%80%81%E7%9A%84%E7%9B%B8%E5%85%B3%E6%8A%80%E6%9C%AF%E5%8F%8A%E5%85%B6%E5%AE%9E%E6%96%BD%E8%BF%87%E7%A8%8B%E3%80%82.%20%E6%AF%94%E5%A6%82%E7%94%A8%E6%88%B7%E6%9F%90%E4%B8%AAicon%E7%82%B9%E5%87%BB%E6%AC%A1%E6%95%B0%E3%80%81%E8%A7%82%E7%9C%8B%E6%9F%90%E4%B8%AA%E8%A7%86%E9%A2%91%E7%9A%84%E6%97%B6%E9%95%BF%E7%AD%89%E7%AD%89%E3%80%82.%20%E5%9F%8B%E7%82%B9%E7%9A%84%E6%8A%80%E6%9C%AF%E5%AE%9E%E8%B4%A8%EF%BC%8C%E6%98%AF%E5%85%88%E7%9B%91%E5%90%AC%E8%BD%AF%E4%BB%B6%E5%BA%94%E7%94%A8%E8%BF%90%E8%A1%8C%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E4%BA%8B%E4%BB%B6%EF%BC%8C%E5%BD%93%E9%9C%80%E8%A6%81%E5%85%B3%E6%B3%A8%E7%9A%84%E4%BA%8B%E4%BB%B6%E5%8F%91%E7%94%9F%E6%97%B6%E8%BF%9B%E8%A1%8C%E5%88%A4%E6%96%AD%E5%92%8C%E6%8D%95%E8%8E%B7%E3%80%82.,%E7%89%B9%E5%88%AB%E6%B3%A8%E6%84%8F%E9%9C%80%E8%A6%81%E6%98%8E%E7%A1%AE%E4%BA%8B%E4%BB%B6%E5%8F%91%E7%94%9F%E6%97%B6%E9%97%B4%E7%82%B9%E3%80%81%E5%88%A4%E5%88%AB%E6%9D%A1%E4%BB%B6%EF%BC%8C%E8%BF%99%E9%87%8C%E5%A6%82%E6%9E%9C%E9%81%87%E5%88%B0%E4%B8%8D%E6%B8%85%E6%A5%9A%E7%9A%84%EF%BC%8C%E9%9C%80%E8%A6%81%E5%92%8C%E5%BC%80%E5%8F%91%E6%B2%9F%E9%80%9A%E6%B8%85%E6%A5%9A%EF%BC%8C%E9%81%BF%E5%85%8D%E9%87%87%E9%9B%86%E6%95%B0%E6%8D%AE%E4%B8%8E%E7%90%86%E6%83%B3%E5%AD%98%E5%9C%A8%E5%B7%AE%E5%BC%82%E3%80%82.%20%E4%BE%8B%E5%A6%82%EF%BC%9A%E6%9C%9F%E6%9C%9B%E9%87%87%E9%9B%86%E6%9F%90%E4%B8%AAapp%E7%9A%84%E6%9F%90%E4%B8%AA%E5%B9%BF%E5%91%8A%E7%9A%84%E6%9C%89%E6%95%88%E6%9B%9D%E5%85%89%E6%95%B0%EF%BC%8C%E6%9C%89%E6%95%88%E6%9B%9D%E5%85%89%E7%9A%84%E5%88%A4%E5%88%AB%E6%9D%A1%E4%BB%B6%E6%98%AF%E5%81%9C%E7%95%99%E6%97%B6%E9%95%BF%E8%B6%85%E8%BF%871%E7%A7%92%E4%B8%94%E6%9C%89%E6%95%88%E5%8A%A0%E8%BD%BD%E5%87%BA%E5%B9%BF%E5%91%8A%E5%86%85%E5%AE%B9%E3%80%82.%202.%20%E5%9F%8B%E7%82%B9%E6%98%AF%E8%B0%81%E7%9A%84%E5%B7%A5%E4%BD%9C%EF%BC%9F.%20%E7%8E%B0%E5%9C%A8%E5%85%AC%E5%8F%B8%E9%80%9A%E5%B8%B8%E9%83%BD%E4%BC%9A%E6%9C%89%E6%95%B0%E6%8D%AE%E4%BA%A7%E5%93%81%E7%BB%8F%E7%90%86%E6%88%96%E4%B8%9A%E5%8A%A1%E7%BA%BF%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E5%B8%88%EF%BC%8C%E7%BB%93%E5%90%88%E7%89%88%E6%9C%AC%E8%BF%AD%E4%BB%A3%E8%BF%87%E7%A8%8B%E8%BF%9B%E8%A1%8C%E5%9F%8B%E7%82%B9%E8%A7%84%E5%88%92%E3%80%82." target="_blank" rel="noreferrer">从数据产品经理视角，聊聊埋点的意义 | 人人都是产品经理 (woshipm.com)</a></p><p>基于此我们可以知道埋点是实际上是对特定事件或者行为的数据监控和上报，<code>常见的埋点上报方式有ajax，img，navigator.sendBeacon下面介绍下这三种埋点上报方式</code></p><h2 id="基于ajax的埋点上报" tabindex="-1">基于ajax的埋点上报 <a class="header-anchor" href="#基于ajax的埋点上报" aria-label="Permalink to &quot;基于ajax的埋点上报&quot;">​</a></h2><h3 id="介绍" tabindex="-1">介绍 <a class="header-anchor" href="#介绍" aria-label="Permalink to &quot;介绍&quot;">​</a></h3><p>因为埋点实际上是对关键节点的数据进行上报是和服务端交互的一个过程，所以我们可以和后端约定一个接口通过ajax去进行数据上报。</p><h3 id="代码实现" tabindex="-1">代码实现 <a class="header-anchor" href="#代码实现" aria-label="Permalink to &quot;代码实现&quot;">​</a></h3><p>我们可以封装一个方法，代码如下：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">buryingPointAjax</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">data</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">resolve</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;font-style:italic;">reject</span><span style="color:#89DDFF;">)</span><span style="color:#F07178;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 创建ajax请求</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#C792EA;">const</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">xhr</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">new</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">XMLHttpRequest</span><span style="color:#F07178;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 定义请求接口</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">open</span><span style="color:#F07178;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">post</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">/buryingPoint</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 发送数据</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">xhr</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">send</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>使用时，直接调用即可</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> info </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{}</span></span>
<span class="line"><span style="color:#82AAFF;">buryingPointAjax</span><span style="color:#BABED8;">(info) </span><span style="color:#676E95;font-style:italic;">// 这样就成功上报了info的对象</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="缺点" tabindex="-1">缺点 <a class="header-anchor" href="#缺点" aria-label="Permalink to &quot;缺点&quot;">​</a></h3><p>一般而言，埋点域名并不是当前域名，因此请求会存在跨域风险，且如果ajax配置不正确可能会浏览器拦截。因此使用ajax这类请求并不是万全之策。</p><h2 id="基于img的埋点上报" tabindex="-1">基于img的埋点上报 <a class="header-anchor" href="#基于img的埋点上报" aria-label="Permalink to &quot;基于img的埋点上报&quot;">​</a></h2><p>上面可以看到如果使用ajax的话，会存在跨域的问题。而且数据上报前端主要是负责将数据传递到后端，并不过分强调前后端交互。<br> 因此我们可以通过一些支持跨域的标签去实现数据上报功能。</p><p><code>script，link，img就是我们上报的数据的最好对象</code></p><p>先说结论，这里推荐使用img标签去实现。</p><h3 id="script及link的缺陷" tabindex="-1">script及link的缺陷 <a class="header-anchor" href="#script及link的缺陷" aria-label="Permalink to &quot;script及link的缺陷&quot;">​</a></h3><p>因为埋点涉及到请求，因此<code>我们需要保证script和link标签的src可以正常请求</code>。<br> 如果需要请求script和link，我们需要将标签挂载到页面上。</p><h4 id="验证缺陷" tabindex="-1">验证缺陷 <a class="header-anchor" href="#验证缺陷" aria-label="Permalink to &quot;验证缺陷&quot;">​</a></h4><p>不妨验证下，我们在管理台中加入以下代码：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> a </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">createElement</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">script</span><span style="color:#89DDFF;">&#39;</span><span style="color:#BABED8;">)</span></span>
<span class="line"><span style="color:#BABED8;">a</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">src </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">https://lf-headquarters-speed.yhgfb-cn-static.com/obj/rc-client-security/web/stable/1.0.0.28/bdms.js</span><span style="color:#89DDFF;">&#39;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>创建一个script标签，未挂载中页面上，并不会发起请求</p><p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e16dc460ae024dd3b67364289e88e6e8~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p><p>书接上文，当我们将这个标签挂载中页面上时：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">document</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">body</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">appendChild</span><span style="color:#BABED8;">(a)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这时发起了请求</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3f7ce1397fe40eba2c2f2522ba2d76c~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p><h4 id="结论" tabindex="-1">结论 <a class="header-anchor" href="#结论" aria-label="Permalink to &quot;结论&quot;">​</a></h4><p><code>当我们使用script和link进行埋点上报时，需要挂载到页面上，而反复操作dom会造成页面性能受影响，而且载入js/css资源还会阻塞页面渲染，影响用户体验</code>，因此对于需要频繁上报的埋点而言，script和link并不合适。</p><h3 id="基于img做埋点上报" tabindex="-1">基于img做埋点上报 <a class="header-anchor" href="#基于img做埋点上报" aria-label="Permalink to &quot;基于img做埋点上报&quot;">​</a></h3><p>通常使用img标签去做埋点上报，<code>img标签加载并不需要挂载到页面上，基于js去new image()，设置其src之后就可以直接请求图片。</code></p><h4 id="验证img优势" tabindex="-1">验证img优势 <a class="header-anchor" href="#验证img优势" aria-label="Permalink to &quot;验证img优势&quot;">​</a></h4><p>控制台去创建一个image标签，如下：</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">var</span><span style="color:#BABED8;"> img</span><span style="color:#89DDFF;">=new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">Image</span><span style="color:#BABED8;">()</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#BABED8;">img</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">src</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/img/MaskGroup.13dfc4f1.png</span><span style="color:#89DDFF;">&quot;</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>可以看到即便未被挂载到页面上依旧发起了请求。</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/a6ced0b11af44a8db149c2b955ce5554~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p><h4 id="结论-1" tabindex="-1">结论 <a class="header-anchor" href="#结论-1" aria-label="Permalink to &quot;结论&quot;">​</a></h4><p>因此当我们做埋点上报时，使用img是一个不错的选择。</p><ol><li>img兼容性好</li><li>无需挂载到页面上，反复操作dom</li><li>img的加载不会阻塞html的解析，但img加载后并不渲染，它需要等待Render Tree生成完后才和Render Tree一起渲染出来</li></ol><p>注：通常埋点上报会使用gif图，<strong>合法的 GIF 只需要 43 个字节</strong></p><h2 id="基于navigator-sendbeacon的埋点上报" tabindex="-1">基于Navigator.sendBeacon的埋点上报 <a class="header-anchor" href="#基于navigator-sendbeacon的埋点上报" aria-label="Permalink to &quot;基于Navigator.sendBeacon的埋点上报&quot;">​</a></h2><p>Navigator.sendBeacon是目前通用的埋点上报方案，<code>Navigator.sendBeacon方法接受两个参数，第一个参数是目标服务器的 URL，第二个参数是所要发送的数据（可选），可以是任意类型（字符串、表单对象、二进制对象等等）。</code></p><h3 id="介绍-1" tabindex="-1">介绍 <a class="header-anchor" href="#介绍-1" aria-label="Permalink to &quot;介绍&quot;">​</a></h3><p><strong><code>navigator.sendBeacon()</code></strong>  方法可用于通过 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTTP%2FMethods%2FPOST" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Methods/POST" target="_blank" rel="noreferrer">HTTP POST</a> 将少量数据 <a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FGlossary%2FAsynchronous" title="https://developer.mozilla.org/zh-CN/docs/Glossary/Asynchronous" target="_blank" rel="noreferrer">异步</a> 传输到 Web 服务器。</p><h3 id="作用" tabindex="-1">作用 <a class="header-anchor" href="#作用" aria-label="Permalink to &quot;作用&quot;">​</a></h3><p>它主要用于将统计数据发送到 Web 服务器，同时避免了用传统技术（如：<a href="https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FXMLHttpRequest" title="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="noreferrer"><code>XMLHttpRequest</code></a>）发送分析数据的一些问题。</p><h3 id="补充" tabindex="-1">补充 <a class="header-anchor" href="#补充" aria-label="Permalink to &quot;补充&quot;">​</a></h3><p>sendBeacon 如果成功进入浏览器的发送队列后，会返回true；如果受到队列总数、数据大小的限制后，会返回false。返回ture后，只是表示进入了发送队列，浏览器会尽力保证发送成功，但是否成功了，不会再有任何返回值。</p><h3 id="例子" tabindex="-1">例子 <a class="header-anchor" href="#例子" aria-label="Permalink to &quot;例子&quot;">​</a></h3><p>以掘金为例：</p><p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2bc94e670c3d4f6d8778c10223227184~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p><p>这里发了一个post请求，将小量的数据发到服务端，用于统计数据</p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/883526b26fbf40c99d316437b27717bb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?" alt="image.png"></p><h3 id="优势" tabindex="-1">优势 <a class="header-anchor" href="#优势" aria-label="Permalink to &quot;优势&quot;">​</a></h3><p>相较于img标签，使用navigator.sendBeacon会更规范，数据传输上可传输资源类型会更多。</p><p>对于ajax在页面卸载时上报，ajax有可能没上报完，页面就卸载了导致请求中断，因此ajax处理这种情况时必须作为同步操作.</p><p><code>sendBeacon是异步的，不会影响当前页到下一个页面的跳转速度，且不受同域限制。这个方法还是异步发出请求，但是请求与当前页面脱离关联，作为浏览器的任务，因此可以保证会把数据发出去，不拖延卸载流程。</code></p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-label="Permalink to &quot;总结&quot;">​</a></h2><p>前端埋点上报常使用ajax，img，navigator.sendBeacon。<br> 不推荐使用ajax。<br> 如果考虑兼容性的话，img是不二之选。<br> 目前最合适的方案是navigator.sendBeacon，不仅是异步的，而且不受同域限制，而且作为浏览器的任务，因此可以保证会把数据发出去，不影响页面卸载。</p><h2 id="常见埋点行为" tabindex="-1">常见埋点行为 <a class="header-anchor" href="#常见埋点行为" aria-label="Permalink to &quot;常见埋点行为&quot;">​</a></h2><h2 id="点击触发埋点" tabindex="-1">点击触发埋点 <a class="header-anchor" href="#点击触发埋点" aria-label="Permalink to &quot;点击触发埋点&quot;">​</a></h2><p>绑定点击事件，当点击目标元素时，触发埋点上报。</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">clickButton</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">url</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">data</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">navigator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendBeacon</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">data</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="页面停留时间上报埋点" tabindex="-1">页面停留时间上报埋点 <a class="header-anchor" href="#页面停留时间上报埋点" aria-label="Permalink to &quot;页面停留时间上报埋点&quot;">​</a></h2><p>路由文件中，初始化一个startTime，当页面离开时通过路由守卫计算停留时间。</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> url </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;&#39;</span><span style="color:#676E95;font-style:italic;">// 上报地址</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> startTime </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#BABED8;">()</span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> currentTime </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">&#39;&#39;</span></span>
<span class="line"><span style="color:#BABED8;">router</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">beforeEach</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">to</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">from</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#BABED8;font-style:italic;">next</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">to</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">         </span><span style="color:#BABED8;">currentTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">         </span><span style="color:#BABED8;">stayTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#82AAFF;">parseInt</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">currentTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">-</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">         </span><span style="color:#BABED8;">navigator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendBeacon</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">time</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">stayTime</span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">         </span><span style="color:#BABED8;">startTime</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">=</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">Date</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">now</span><span style="color:#F07178;">()</span></span>
<span class="line"><span style="color:#F07178;">     </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="错误监听埋点" tabindex="-1">错误监听埋点 <a class="header-anchor" href="#错误监听埋点" aria-label="Permalink to &quot;错误监听埋点&quot;">​</a></h2><p>通过监听函数去接收错误信息。</p><h3 id="vue错误捕获" tabindex="-1">vue错误捕获 <a class="header-anchor" href="#vue错误捕获" aria-label="Permalink to &quot;vue错误捕获&quot;">​</a></h3><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">app</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">config</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">errorHandler</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">err</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">navigator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendBeacon</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">error</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">error</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">message</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">vue运行异常</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="js异常与静态资源加载异常" tabindex="-1">JS异常与静态资源加载异常 <a class="header-anchor" href="#js异常与静态资源加载异常" aria-label="Permalink to &quot;JS异常与静态资源加载异常&quot;">​</a></h3><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">window</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">addEventListener</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">error</span><span style="color:#89DDFF;">&#39;</span><span style="color:#89DDFF;">,</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">error</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">error</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">message</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">navigator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendBeacon</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">error</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">error</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">message</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">js执行异常</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">        </span><span style="color:#BABED8;">navigator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendBeacon</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">error</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">error</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">filename</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">资源加载异常</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#89DDFF;">},</span><span style="color:#BABED8;"> </span><span style="color:#FF9CAC;">true</span><span style="color:#BABED8;">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="请求错误捕获" tabindex="-1">请求错误捕获 <a class="header-anchor" href="#请求错误捕获" aria-label="Permalink to &quot;请求错误捕获&quot;">​</a></h3><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#BABED8;">axios</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">interceptors</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">response</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">use</span><span style="color:#BABED8;">(</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">response</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;font-style:italic;">if</span><span style="color:#F07178;"> (</span><span style="color:#BABED8;">response</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">code</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">==</span><span style="color:#F07178;"> </span><span style="color:#F78C6C;">200</span><span style="color:#F07178;">) </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">resolve</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">response</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;font-style:italic;">else</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#F07178;">      </span><span style="color:#89DDFF;font-style:italic;">return</span><span style="color:#F07178;"> </span><span style="color:#FFCB6B;">Promise</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">reject</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">response</span><span style="color:#F07178;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">},</span></span>
<span class="line"><span style="color:#BABED8;">  </span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">error</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#C792EA;">=&gt;</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#89DDFF;">    </span><span style="color:#676E95;font-style:italic;">// 返回错误逻辑</span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">navigator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendBeacon</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;">error</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">error</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">请求错误异常</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">)</span></span>
<span class="line"><span style="color:#F07178;">  </span><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="内容可见埋点" tabindex="-1">内容可见埋点 <a class="header-anchor" href="#内容可见埋点" aria-label="Permalink to &quot;内容可见埋点&quot;">​</a></h2><p>通过交叉观察器去监听当前元素是否出现在页面</p><div class="language-javascript line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">javascript</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;">// 可见性发生变化后的回调 </span></span>
<span class="line"><span style="color:#C792EA;">function</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">callback</span><span style="color:#89DDFF;">(</span><span style="color:#BABED8;font-style:italic;">data</span><span style="color:#89DDFF;">)</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> </span></span>
<span class="line"><span style="color:#F07178;">    </span><span style="color:#BABED8;">navigator</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">sendBeacon</span><span style="color:#F07178;">(</span><span style="color:#BABED8;">url</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">{</span><span style="color:#F07178;"> target</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#BABED8;">data</span><span style="color:#F07178;">[</span><span style="color:#F78C6C;">0</span><span style="color:#F07178;">]</span><span style="color:#89DDFF;">.</span><span style="color:#BABED8;">target</span><span style="color:#89DDFF;">,</span><span style="color:#F07178;"> text</span><span style="color:#89DDFF;">:</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">&#39;</span><span style="color:#C3E88D;">内容可见</span><span style="color:#89DDFF;">&#39;</span><span style="color:#F07178;"> </span><span style="color:#89DDFF;">}</span><span style="color:#F07178;">) </span></span>
<span class="line"><span style="color:#89DDFF;">}</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 交叉观察器配置项 </span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> options </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">{};</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 生成交叉观察器 </span></span>
<span class="line"><span style="color:#C792EA;">const</span><span style="color:#BABED8;"> observer </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> </span><span style="color:#89DDFF;">new</span><span style="color:#BABED8;"> </span><span style="color:#82AAFF;">IntersectionObserver</span><span style="color:#BABED8;">(callback)</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 获取目标节点 </span></span>
<span class="line"><span style="color:#C792EA;">let</span><span style="color:#BABED8;"> target </span><span style="color:#89DDFF;">=</span><span style="color:#BABED8;"> document</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">getElementById</span><span style="color:#BABED8;">(</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">target</span><span style="color:#89DDFF;">&quot;</span><span style="color:#BABED8;">)</span><span style="color:#89DDFF;">;</span><span style="color:#BABED8;"> </span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">// 监听目标元素 </span></span>
<span class="line"><span style="color:#BABED8;">observer</span><span style="color:#89DDFF;">.</span><span style="color:#82AAFF;">observe</span><span style="color:#BABED8;">(target)</span><span style="color:#89DDFF;">;</span></span>
<span class="line"></span>
<span class="line"></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><a href="https://juejin.cn/post/7224132741997281338" target="_blank" rel="noreferrer">原文</a></p>`,84),e=[o];function r(t,c,E,F,i,B){return a(),n("div",null,e)}const A=s(p,[["render",r]]);export{D as __pageData,A as default};
